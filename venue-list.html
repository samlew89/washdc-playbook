<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DC Venue Pipeline</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Figtree', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fff;
            color: #333;
        }

        .header {
            background: #fff;
            color: #000;
            padding: 30px 20px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        .header h1 { font-size: 32px; margin-bottom: 8px; font-weight: 900; }
        .header p { color: #7d7d7d; font-size: 15px; }

        .stats {
            background: #f7f7f7;
            color: #000;
            padding: 20px;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: center;
            border-bottom: 1px solid #eee;
        }
        .stat { text-align: center; }
        .stat-value { font-size: 28px; font-weight: 700; color: #5e25fd; }
        .stat-label { font-size: 11px; color: #7d7d7d; text-transform: uppercase; letter-spacing: 1px; }
        .stat-value.contacted { color: #3b82f6; }
        .stat-value.meeting { color: #8b5cf6; }
        .stat-value.installed { color: #10b981; }
        .stat-value.rejected { color: #ef4444; }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* Filters */
        .filters {
            padding: 15px 20px;
            background: #f7f7f7;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            border-bottom: 1px solid #eee;
            border-radius: 12px 12px 0 0;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .filter-group label {
            font-weight: 600;
            font-size: 13px;
            color: #7d7d7d;
        }
        .filter-group select, .filter-group input[type="text"] {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 13px;
            min-width: 150px;
            font-family: 'Figtree', sans-serif;
        }
        .filter-group select:focus, .filter-group input[type="text"]:focus {
            outline: none;
            border-color: #5e25fd;
        }
        .filter-group input[type="text"] { min-width: 200px; }

        /* Category chips */
        .category-chips {
            padding: 14px 20px;
            background: #fff;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
            border-bottom: 1px solid #eee;
        }
        .category-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        .category-chip.active {
            background: #5e25fd;
            color: white;
        }
        .category-chip:not(.active) {
            background: #f3f4f6;
            color: #4b5563;
        }
        .category-chip:not(.active):hover {
            background: #e5e7eb;
        }
        .category-chip .chip-count {
            background: rgba(255,255,255,0.25);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
        .category-chip:not(.active) .chip-count {
            background: rgba(0,0,0,0.08);
        }

        /* Venue list */
        .venue-section {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .venue-list {
            padding: 0;
        }

        .venue-card {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }
        .venue-card:last-child { border-bottom: none; }
        .venue-card:hover { background: #fafafa; }

        .venue-card-main {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: center;
        }

        .venue-info h3 a {
            color: #000;
            text-decoration: none;
        }
        .venue-info h3 a:hover {
            color: #5e25fd;
            text-decoration: underline;
        }

        .venue-info h3 {
            font-size: 15px;
            margin-bottom: 4px;
            color: #000;
            font-weight: 600;
        }
        .venue-meta {
            font-size: 13px;
            color: #666;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        .venue-meta span { display: flex; align-items: center; gap: 4px; }


        .venue-score {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .score-badge {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            color: white;
        }
        .score-critical { background: #5e25fd; }
        .score-high { background: #036afd; }
        .score-medium { background: #f97316; }
        .score-low { background: #ef4444; }

        .score-tier {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Stage selector */
        .stage-row {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f0f0f0;
        }

        .stage-trigger {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 6px;
            transition: background 0.2s;
            user-select: none;
        }
        .stage-trigger:hover {
            background: #f3f4f6;
        }

        .stage-trigger .arrow {
            font-size: 10px;
            transition: transform 0.2s;
        }
        .stage-trigger.expanded .arrow {
            transform: rotate(90deg);
        }

        .stage-pill {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .stage-pill.not-started { background: #f3f4f6; color: #6b7280; }
        .stage-pill.contacted { background: #dbeafe; color: #1d4ed8; }
        .stage-pill.meeting-set { background: #ede9fe; color: #6d28d9; }
        .stage-pill.negotiating { background: #fef3c7; color: #b45309; }
        .stage-pill.installed { background: #d1fae5; color: #047857; }
        .stage-pill.rejected { background: #fee2e2; color: #b91c1c; }

        .stage-options {
            display: none;
            margin-top: 10px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
        }
        .stage-options.visible {
            display: block;
        }

        .stage-options-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .stage-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
            font-size: 13px;
            font-weight: 500;
        }
        .stage-option:hover {
            background: #fff;
            border-color: #e5e7eb;
        }
        .stage-option.selected {
            background: #fff;
            border-color: #5e25fd;
        }
        .stage-option .radio {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid #d1d5db;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .stage-option.selected .radio {
            border-color: #5e25fd;
        }
        .stage-option.selected .radio::after {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #5e25fd;
        }

        .stage-saving {
            font-size: 11px;
            color: #6b7280;
            margin-top: 8px;
            display: none;
        }
        .stage-saving.visible {
            display: block;
        }

        /* Notes */
        .notes-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e5e7eb;
        }
        .notes-label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 6px;
        }
        .notes-input {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 13px;
            font-family: 'Figtree', sans-serif;
            resize: vertical;
            min-height: 60px;
        }
        .notes-input:focus {
            outline: none;
            border-color: #5e25fd;
        }
        .notes-input::placeholder {
            color: #9ca3af;
        }
        .notes-indicator {
            display: inline-flex;
            align-items: center;
            margin-left: 8px;
            color: #9ca3af;
            font-size: 12px;
        }
        .notes-indicator svg {
            width: 14px;
            height: 14px;
        }

        /* Show more button */
        .show-more {
            padding: 15px 20px;
            text-align: center;
            border-top: 1px solid #eee;
        }
        .show-more button {
            background: #5e25fd;
            color: white;
            border: none;
            padding: 10px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            font-family: 'Figtree', sans-serif;
            transition: background 0.2s;
        }
        .show-more button:hover { background: #4a1dcc; }

        /* Empty state */
        .empty-state {
            padding: 40px 20px;
            text-align: center;
            color: #666;
        }

        /* Results count */
        .results-count {
            padding: 10px 20px;
            background: #fff;
            font-size: 13px;
            color: #666;
            border-bottom: 1px solid #eee;
        }
        .results-count strong {
            color: #5e25fd;
        }

        /* Loading and error states */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9998;
        }
        .loading-overlay.hidden {
            display: none;
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #5e25fd;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-banner {
            background: #fef2f2;
            color: #b91c1c;
            padding: 12px 20px;
            text-align: center;
            font-size: 14px;
            display: none;
        }
        .error-banner.visible {
            display: block;
        }

        /* Offline mode banner */
        .offline-banner {
            background: #fef3c7;
            color: #92400e;
            padding: 8px 20px;
            text-align: center;
            font-size: 13px;
            display: none;
        }
        .offline-banner.visible {
            display: block;
        }

        /* Mobile styles */
        @media (max-width: 768px) {
            .header {
                padding: 20px 16px;
            }
            .header h1 {
                font-size: 24px;
            }

            .stats {
                gap: 8px;
                padding: 12px 16px;
            }
            .stat-value {
                font-size: 18px;
            }
            .stat-label {
                font-size: 8px;
            }

            .container {
                padding: 12px;
            }

            .filters {
                padding: 12px 16px;
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }
            .filter-group {
                flex-direction: column;
                align-items: stretch;
                gap: 4px;
            }
            .filter-group select,
            .filter-group input[type="text"] {
                min-width: auto;
                width: 100%;
            }

            .category-chips {
                padding: 10px 16px;
                overflow-x: auto;
                flex-wrap: nowrap;
            }
            .category-chip {
                flex-shrink: 0;
            }

            .venue-card {
                padding: 12px 16px;
            }
            .venue-card-main {
                grid-template-columns: 1fr;
            }
            .venue-score {
                flex-direction: row;
                justify-content: flex-start;
                gap: 10px;
            }
            .score-badge {
                width: 40px;
                height: 40px;
                font-size: 14px;
            }

            .stage-options-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Password Gate Styles */
        .password-gate {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            z-index: 99999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        .password-gate.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .password-box {
            background: #fff;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            text-align: center;
            max-width: 360px;
            width: 90%;
        }
        .password-box h2 {
            font-family: 'Figtree', sans-serif;
            font-size: 24px;
            font-weight: 800;
            color: #000;
            margin-bottom: 8px;
        }
        .password-box p {
            font-family: 'Figtree', sans-serif;
            color: #666;
            font-size: 14px;
            margin-bottom: 24px;
        }
        .password-box input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            font-family: 'Figtree', sans-serif;
            margin-bottom: 16px;
            transition: border-color 0.2s;
        }
        .password-box input:focus {
            outline: none;
            border-color: #5e25fd;
        }
        .password-box input.error {
            border-color: #ef4444;
            animation: shake 0.4s ease;
        }
        .password-box button {
            width: 100%;
            padding: 14px 24px;
            background: #5e25fd;
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            font-family: 'Figtree', sans-serif;
            cursor: pointer;
            transition: background 0.2s;
        }
        .password-box button:hover {
            background: #4a1dcc;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }
    </style>
</head>
<body>
    <!-- Password Gate -->
    <div class="password-gate" id="passwordGate">
        <div class="password-box">
            <h2>DC Playbook</h2>
            <p>Enter password to continue</p>
            <input type="password" id="passwordInput" placeholder="Password" autocomplete="off">
            <button id="passwordSubmit">Enter</button>
        </div>
    </div>
    <script>
        (function() {
            const HASH = 'e740f59c469759dff1f87cfbfef8f055d6c8c3477c3e23f838182829675c078c';
            const AUTH_KEY = 'dc_playbook_auth';

            async function sha256(str) {
                const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
                return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
            }

            function hideGate() {
                const gate = document.getElementById('passwordGate');
                gate.classList.add('hidden');
                setTimeout(() => gate.style.display = 'none', 300);
            }

            if (localStorage.getItem(AUTH_KEY) === 'true') {
                hideGate();
            }

            document.getElementById('passwordSubmit').addEventListener('click', async function() {
                const input = document.getElementById('passwordInput');
                const hash = await sha256(input.value);
                if (hash === HASH) {
                    localStorage.setItem(AUTH_KEY, 'true');
                    hideGate();
                } else {
                    input.classList.add('error');
                    input.value = '';
                    setTimeout(() => input.classList.remove('error'), 400);
                }
            });

            document.getElementById('passwordInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') document.getElementById('passwordSubmit').click();
            });
        })();
    </script>

    <!-- Loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Error banner -->
    <div class="error-banner" id="errorBanner"></div>

    <!-- Offline mode banner -->
    <div class="offline-banner" id="offlineBanner">
        Running in offline mode. Stage changes won't be saved.
    </div>

    <div class="header">
        <h1>DC Venue Pipeline</h1>
        <p>All DC Neighborhoods</p>
    </div>

    <div class="stats">
        <div class="stat">
            <div class="stat-value" id="totalVenues">-</div>
            <div class="stat-label">Total</div>
        </div>
        <div class="stat">
            <div class="stat-value" id="priorityVenues">-</div>
            <div class="stat-label">Priority</div>
        </div>
        <div class="stat">
            <div class="stat-value contacted" id="contactedVenues">-</div>
            <div class="stat-label">Contacted</div>
        </div>
        <div class="stat">
            <div class="stat-value meeting" id="meetingVenues">-</div>
            <div class="stat-label">Meeting Set</div>
        </div>
        <div class="stat">
            <div class="stat-value installed" id="installedVenues">-</div>
            <div class="stat-label">Installed</div>
        </div>
        <div class="stat">
            <div class="stat-value rejected" id="rejectedVenues">-</div>
            <div class="stat-label">Rejected</div>
        </div>
    </div>

    <div class="container">
        <div class="venue-section">
            <div class="filters">
                <div class="filter-group">
                    <label>Search:</label>
                    <input type="text" id="searchInput" placeholder="Name or address...">
                </div>
                <div class="filter-group">
                    <label>Neighborhood:</label>
                    <select id="neighborhoodFilter">
                        <option value="all">All Neighborhoods</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Min Score:</label>
                    <select id="scoreFilter">
                        <option value="0">Any Score</option>
                        <option value="85">85+ (Priority)</option>
                        <option value="60">60+ (High)</option>
                        <option value="45">45+ (Medium+)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Stage:</label>
                    <select id="stageFilter">
                        <option value="all">All Stages</option>
                        <option value="Not Started">Not Started</option>
                        <option value="Contacted">Contacted</option>
                        <option value="Meeting Set">Meeting Set</option>
                        <option value="Negotiating">Negotiating</option>
                        <option value="Installed">Installed</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
            </div>

            <div class="category-chips" id="categoryChips">
                <!-- Populated by JS -->
            </div>

            <div class="results-count" id="resultsCount">Loading...</div>

            <div class="venue-list" id="venueList">
                <div class="empty-state">Loading venues...</div>
            </div>

            <div class="show-more" id="showMore" style="display: none;">
                <button onclick="showMore()">Show More</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================

        // Google Apps Script URL - REPLACE THIS with your deployed web app URL
        // Leave empty to use local CSV (offline mode)
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbziAnC3bPSoCwH85BABM_YkO0SuZ73bAj8G7qqNUfhsXuJ03g78pI8v-XQBEIRG6aUBgQ/exec';

        // Pipeline stages
        const STAGES = [
            { id: 'Not Started', label: 'Not Started', class: 'not-started' },
            { id: 'Contacted', label: 'Contacted', class: 'contacted' },
            { id: 'Meeting Set', label: 'Meeting Set', class: 'meeting-set' },
            { id: 'Negotiating', label: 'Negotiating', class: 'negotiating' },
            { id: 'Installed', label: 'Installed', class: 'installed' },
            { id: 'Rejected', label: 'Rejected', class: 'rejected' }
        ];

        // ============================================
        // DATA STORAGE
        // ============================================

        let allVenues = [];
        let filteredVenues = [];
        let categories = {};
        let neighborhoods = new Set();
        let selectedCategory = null;
        let isOnlineMode = false;
        let expandedVenueId = null;

        // Pagination
        let offset = 0;
        const PAGE_SIZE = 50;

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function parseCSV(text) {
            const lines = text.trim().split('\n');
            const headers = lines[0].split(',');

            return lines.slice(1).map(line => {
                const values = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        values.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current.trim());

                const obj = {};
                headers.forEach((h, i) => {
                    obj[h.trim()] = values[i] || '';
                });

                return {
                    id: obj.ID || '',
                    name: obj.Name || '',
                    address: obj.Address || '',
                    category: obj.Category || '',
                    neighborhood: obj.Neighborhood || '',
                    rating: parseFloat(obj.Rating) || 0,
                    reviews: parseInt(obj.Reviews) || 0,
                    price: obj.Price || '',
                    score: parseInt(obj.Score) || 0,
                    lat: parseFloat(obj.Lat) || 0,
                    lng: parseFloat(obj.Lng) || 0,
                    yelpId: obj.YelpID || '',
                    stage: obj.Stage || 'Not Started',
                    lastUpdated: obj.LastUpdated || ''
                };
            }).filter(v => v.lat !== 0 && v.lng !== 0);
        }

        function getScoreTier(score) {
            if (score >= 85) return { class: 'score-critical', label: 'Priority' };
            if (score >= 60) return { class: 'score-high', label: 'High' };
            if (score >= 45) return { class: 'score-medium', label: 'Medium' };
            return { class: 'score-low', label: 'Low' };
        }

        function getStageInfo(stageId) {
            return STAGES.find(s => s.id === stageId) || STAGES[0];
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('hidden', !show);
        }

        function showError(message) {
            const banner = document.getElementById('errorBanner');
            banner.textContent = message;
            banner.classList.add('visible');
        }

        function hideError() {
            document.getElementById('errorBanner').classList.remove('visible');
        }

        // ============================================
        // DATA LOADING
        // ============================================

        async function loadData() {
            showLoading(true);
            hideError();

            try {
                if (APPS_SCRIPT_URL) {
                    // Try to load from Google Sheets
                    const response = await fetch(APPS_SCRIPT_URL);
                    const data = await response.json();

                    if (data.success) {
                        allVenues = data.venues.map(v => ({
                            id: v.ID || '',
                            name: v.Name || '',
                            address: v.Address || '',
                            category: v.Category || '',
                            neighborhood: v.Neighborhood || '',
                            rating: parseFloat(v.Rating) || 0,
                            reviews: parseInt(v.Reviews) || 0,
                            price: v.Price || '',
                            score: parseInt(v.Score) || 0,
                            lat: parseFloat(v.Lat) || 0,
                            lng: parseFloat(v.Lng) || 0,
                            yelpId: v.YelpID || '',
                            stage: v.Stage || 'Not Started',
                            lastUpdated: v.LastUpdated || ''
                        })).filter(v => v.lat !== 0 && v.lng !== 0);

                        isOnlineMode = true;
                    } else {
                        throw new Error(data.error || 'Failed to load from Google Sheets');
                    }
                } else {
                    // Fall back to local CSV
                    const response = await fetch('dc-venues.csv');
                    const text = await response.text();
                    allVenues = parseCSV(text);
                    isOnlineMode = false;
                    document.getElementById('offlineBanner').classList.add('visible');
                }

                // Build category and neighborhood lists
                allVenues.forEach(v => {
                    categories[v.category] = (categories[v.category] || 0) + 1;
                    neighborhoods.add(v.neighborhood);
                });

                // Initialize filtered data
                filteredVenues = [...allVenues].sort((a, b) => b.score - a.score);

                // Update UI
                updateStats();
                buildCategoryChips();
                buildNeighborhoodDropdown();
                renderVenueList();

            } catch (error) {
                console.error('Error loading data:', error);

                // Try CSV fallback
                try {
                    const response = await fetch('dc-venues.csv');
                    const text = await response.text();
                    allVenues = parseCSV(text);
                    isOnlineMode = false;
                    document.getElementById('offlineBanner').classList.add('visible');

                    allVenues.forEach(v => {
                        categories[v.category] = (categories[v.category] || 0) + 1;
                        neighborhoods.add(v.neighborhood);
                    });

                    filteredVenues = [...allVenues].sort((a, b) => b.score - a.score);
                    updateStats();
                    buildCategoryChips();
                    buildNeighborhoodDropdown();
                    renderVenueList();
                } catch (csvError) {
                    showError('Failed to load venue data. Please refresh the page.');
                    document.getElementById('venueList').innerHTML = '<div class="empty-state">Error loading venue data</div>';
                }
            } finally {
                showLoading(false);
            }
        }

        // ============================================
        // STAGE UPDATE
        // ============================================

        async function updateStage(venueId, newStage) {
            // Find venue and update locally
            const venue = allVenues.find(v => v.id === venueId);
            if (!venue) return;

            const oldStage = venue.stage;
            venue.stage = newStage;
            venue.lastUpdated = new Date().toISOString();

            // Update UI optimistically
            updateStats();
            renderVenueList();

            // If online, sync to Google Sheets
            if (isOnlineMode && APPS_SCRIPT_URL) {
                try {
                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ venueId, stage: newStage })
                    });

                    const result = await response.json();
                    if (!result.success) {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Failed to save stage:', error);
                    // Revert on failure
                    venue.stage = oldStage;
                    updateStats();
                    renderVenueList();
                    showError('Failed to save stage change. Please try again.');
                }
            }
        }

        // ============================================
        // STATS
        // ============================================

        function updateStats() {
            const total = allVenues.length;
            const priority = allVenues.filter(v => v.score >= 85).length;
            const contacted = allVenues.filter(v => v.stage === 'Contacted').length;
            const meeting = allVenues.filter(v => v.stage === 'Meeting Set').length;
            const installed = allVenues.filter(v => v.stage === 'Installed').length;
            const rejected = allVenues.filter(v => v.stage === 'Rejected').length;

            document.getElementById('totalVenues').textContent = total.toLocaleString();
            document.getElementById('priorityVenues').textContent = priority.toLocaleString();
            document.getElementById('contactedVenues').textContent = contacted.toLocaleString();
            document.getElementById('meetingVenues').textContent = meeting.toLocaleString();
            document.getElementById('installedVenues').textContent = installed.toLocaleString();
            document.getElementById('rejectedVenues').textContent = rejected.toLocaleString();
        }

        // ============================================
        // CATEGORY CHIPS
        // ============================================

        function getCategoryCounts() {
            const neighborhoodFilter = document.getElementById('neighborhoodFilter').value;
            const minScore = parseInt(document.getElementById('scoreFilter').value) || 0;
            const stageFilter = document.getElementById('stageFilter').value;
            const counts = { all: 0 };

            allVenues.forEach(v => {
                if (neighborhoodFilter !== 'all' && v.neighborhood !== neighborhoodFilter) return;
                if (v.score < minScore) return;
                if (stageFilter !== 'all' && v.stage !== stageFilter) return;
                counts.all++;
                counts[v.category] = (counts[v.category] || 0) + 1;
            });

            return counts;
        }

        function buildCategoryChips() {
            const container = document.getElementById('categoryChips');
            container.innerHTML = '';

            const counts = getCategoryCounts();

            const allChip = document.createElement('div');
            allChip.className = 'category-chip active';
            allChip.dataset.category = 'all';
            allChip.innerHTML = `All <span class="chip-count">${counts.all}</span>`;
            allChip.addEventListener('click', () => selectCategory(null));
            container.appendChild(allChip);

            const sortedCategories = Object.entries(categories).sort((a, b) => b[1] - a[1]);

            sortedCategories.forEach(([cat, _]) => {
                const count = counts[cat] || 0;
                const chip = document.createElement('div');
                chip.className = 'category-chip';
                chip.dataset.category = cat;
                chip.innerHTML = `${cat} <span class="chip-count">${count}</span>`;
                chip.addEventListener('click', () => selectCategory(cat));
                container.appendChild(chip);
            });
        }

        function updateCategoryChipCounts() {
            const counts = getCategoryCounts();
            const chips = document.querySelectorAll('.category-chip');

            chips.forEach(chip => {
                const cat = chip.dataset.category;
                const count = cat === 'all' ? counts.all : (counts[cat] || 0);
                const countSpan = chip.querySelector('.chip-count');
                if (countSpan) {
                    countSpan.textContent = count;
                }
            });
        }

        function selectCategory(category) {
            selectedCategory = category;

            const chips = document.querySelectorAll('.category-chip');
            chips.forEach(chip => {
                const chipCat = chip.dataset.category;
                if (category === null && chipCat === 'all') {
                    chip.classList.add('active');
                } else if (category === chipCat) {
                    chip.classList.add('active');
                } else {
                    chip.classList.remove('active');
                }
            });

            applyFilters();
        }

        // ============================================
        // FILTERS
        // ============================================

        function buildNeighborhoodDropdown() {
            const select = document.getElementById('neighborhoodFilter');
            Array.from(neighborhoods).sort().forEach(nb => {
                const option = document.createElement('option');
                option.value = nb;
                option.textContent = nb;
                select.appendChild(option);
            });
        }

        function applyFilters() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const neighborhood = document.getElementById('neighborhoodFilter').value;
            const minScore = parseInt(document.getElementById('scoreFilter').value) || 0;
            const stageFilter = document.getElementById('stageFilter').value;

            filteredVenues = allVenues.filter(v => {
                if (search && !v.name.toLowerCase().includes(search) && !v.address.toLowerCase().includes(search)) return false;
                if (neighborhood !== 'all' && v.neighborhood !== neighborhood) return false;
                if (v.score < minScore) return false;
                if (stageFilter !== 'all' && v.stage !== stageFilter) return false;
                if (selectedCategory !== null && v.category !== selectedCategory) return false;
                return true;
            }).sort((a, b) => b.score - a.score);

            offset = 0;
            renderVenueList();
        }

        // ============================================
        // VENUE CARD RENDERING
        // ============================================

        // Notes storage (localStorage)
        function getNote(venueId) {
            const notes = JSON.parse(localStorage.getItem('venue_notes') || '{}');
            return notes[venueId] || '';
        }

        function saveNote(venueId, note) {
            const notes = JSON.parse(localStorage.getItem('venue_notes') || '{}');
            if (note.trim()) {
                notes[venueId] = note;
            } else {
                delete notes[venueId];
            }
            localStorage.setItem('venue_notes', JSON.stringify(notes));
        }

        function handleNoteChange(venueId, textarea) {
            saveNote(venueId, textarea.value);
            // Update the notes indicator without full re-render
            const card = document.querySelector(`[data-venue-id="${venueId}"]`);
            const indicator = card.querySelector('.notes-indicator');
            if (indicator) {
                indicator.style.display = textarea.value.trim() ? 'inline-flex' : 'none';
            }
        }

        function renderVenueCard(venue) {
            const tier = getScoreTier(venue.score);
            const stageInfo = getStageInfo(venue.stage);
            const yelpUrl = venue.yelpId ? `https://www.yelp.com/biz/${venue.yelpId}` : `https://www.google.com/search?q=${encodeURIComponent(venue.name + ' ' + venue.address)}`;
            const isExpanded = expandedVenueId === venue.id;
            const note = getNote(venue.id);
            const hasNote = note.trim().length > 0;

            const stageOptionsHtml = STAGES.map(s => `
                <div class="stage-option ${s.id === venue.stage ? 'selected' : ''}"
                     onclick="handleStageSelect('${venue.id}', '${s.id}')">
                    <div class="radio"></div>
                    ${s.label}
                </div>
            `).join('');

            return `
                <div class="venue-card" data-venue-id="${venue.id}">
                    <div class="venue-card-main">
                        <div class="venue-info">
                            <h3><a href="${yelpUrl}" target="_blank" rel="noopener">${venue.name}</a></h3>
                            <div class="venue-meta">
                                <span>${venue.address}</span>
                                <span>${venue.category}</span>
                                <span>${venue.neighborhood}</span>
                            </div>
                        </div>
                        <div class="venue-score">
                            <div class="score-badge ${tier.class}">${venue.score}</div>
                            <div class="score-tier">${tier.label}</div>
                        </div>
                    </div>
                    <div class="stage-row">
                        <div class="stage-trigger ${isExpanded ? 'expanded' : ''}" onclick="toggleStageSelector('${venue.id}')">
                            <span class="arrow">&#9654;</span>
                            <span class="stage-pill ${stageInfo.class}">${stageInfo.label}</span>
                            <span class="notes-indicator" style="display: ${hasNote ? 'inline-flex' : 'none'}">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </span>
                        </div>
                        <div class="stage-options ${isExpanded ? 'visible' : ''}" id="stage-options-${venue.id}">
                            <div class="stage-options-grid">
                                ${stageOptionsHtml}
                            </div>
                            <div class="stage-saving" id="stage-saving-${venue.id}">Saving...</div>
                            <div class="notes-section">
                                <div class="notes-label">Notes (saved locally)</div>
                                <textarea class="notes-input"
                                    placeholder="Add notes about this venue..."
                                    oninput="handleNoteChange('${venue.id}', this)"
                                    onclick="event.stopPropagation()">${note}</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function toggleStageSelector(venueId) {
            if (expandedVenueId === venueId) {
                expandedVenueId = null;
            } else {
                expandedVenueId = venueId;
            }
            renderVenueList();
        }

        async function handleStageSelect(venueId, stageId) {
            const venue = allVenues.find(v => v.id === venueId);
            if (!venue || venue.stage === stageId) return;

            // Show saving indicator
            const savingEl = document.getElementById(`stage-saving-${venueId}`);
            if (savingEl) savingEl.classList.add('visible');

            await updateStage(venueId, stageId);

            // Collapse after selection
            expandedVenueId = null;
        }

        function renderVenueList() {
            const list = document.getElementById('venueList');
            const shown = filteredVenues.slice(0, offset + PAGE_SIZE);

            document.getElementById('resultsCount').innerHTML = `Showing <strong>${shown.length}</strong> of <strong>${filteredVenues.length}</strong> venues`;

            if (shown.length === 0) {
                list.innerHTML = '<div class="empty-state">No venues match your filters</div>';
                document.getElementById('showMore').style.display = 'none';
                return;
            }

            list.innerHTML = shown.map(v => renderVenueCard(v)).join('');

            const showMoreDiv = document.getElementById('showMore');
            if (shown.length < filteredVenues.length) {
                showMoreDiv.style.display = 'block';
                showMoreDiv.querySelector('button').textContent = `Show More (${filteredVenues.length - shown.length} remaining)`;
            } else {
                showMoreDiv.style.display = 'none';
            }
        }

        function showMore() {
            offset += PAGE_SIZE;
            renderVenueList();
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================

        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('neighborhoodFilter').addEventListener('change', function() {
            updateCategoryChipCounts();
            applyFilters();
        });
        document.getElementById('scoreFilter').addEventListener('change', function() {
            updateCategoryChipCounts();
            applyFilters();
        });
        document.getElementById('stageFilter').addEventListener('change', function() {
            updateCategoryChipCounts();
            applyFilters();
        });

        // ============================================
        // INITIALIZE
        // ============================================

        loadData();
    </script>
</body>
</html>
